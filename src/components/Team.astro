---
import { clinic } from "../data/clinic";
import TeamMemberCard from "./TeamMemberCard.astro";
---

<section id="equipa" class="section">
  <div class="container">
    <div class="section-head text-center">
      <h2 class="text-balance">Equipa</h2>
      <p class="subtitle mx-auto">
        Profissionais com formação especializada para apoiar a sua recuperação.
      </p>
    </div>
  </div>

  <div class="relative w-full group" data-team-carousel>
    <!-- Track -->
    <div
      data-carousel-track
      tabindex="0"
      class="overflow-x-auto scroll-smooth
        snap-x snap-mandatory
        px-4 sm:px-6 md:px-10
        [-ms-overflow-style:none]
        [scrollbar-width:none]
        [&::-webkit-scrollbar]:hidden"
    >
      <div class="flex gap-4 md:gap-6 py-2">
        {
          clinic.team.map((member, i) => (
            <div
              class="snap-start shrink-0 basis-full md:basis-1/2"
              data-carousel-item={String(i)}
            >
              <TeamMemberCard member={member} />
            </div>
          ))
        }
      </div>
    </div>

    <!-- CLICKABLE OVERLAY LAYER -->
    <div class="pointer-events-none absolute inset-0 z-[9999]">
      <button
        type="button"
        aria-label="Anterior"
        data-carousel-prev
        class="pointer-events-auto
      absolute left-3 sm:left-5 md:left-7 top-1/2 -translate-y-1/2
      btn-secondary !px-3 !py-2.5
      opacity-100 md:opacity-0 md:group-hover:opacity-100
      transition-opacity"
      >
        ←
      </button>

      <button
        type="button"
        aria-label="Seguinte"
        data-carousel-next
        class="pointer-events-auto
      absolute right-3 sm:right-5 md:right-7 top-1/2 -translate-y-1/2
      btn-secondary !px-3 !py-2.5
      opacity-100 md:opacity-0 md:group-hover:opacity-100
      transition-opacity"
      >
        →
      </button>
    </div>

    <!-- Page dots container (JS renders them) -->
    <div class="mt-4 flex items-center justify-center gap-2" data-carousel-dots>
    </div>

    <script is:inline>
      (() => {
        const init = () => {
          const root = document.querySelector("[data-team-carousel]");
          if (!root) return;

          const track = root.querySelector("[data-carousel-track]");
          const prev = root.querySelector("[data-carousel-prev]");
          const next = root.querySelector("[data-carousel-next]");
          const dotsContainer = root.querySelector("[data-carousel-dots]");
          const items = Array.from(
            root.querySelectorAll("[data-carousel-item]")
          );

          if (!track || !prev || !next || !dotsContainer || items.length === 0)
            return;

          const perView = () =>
            window.matchMedia("(min-width: 768px)").matches ? 2 : 1;

          // Compute each item's left offset relative to the track scroll container
          const itemLefts = () => items.map((el) => el.offsetLeft);

          const currentIndex = () => {
            const lefts = itemLefts();
            const x = track.scrollLeft;
            let best = 0;
            let bestDist = Infinity;

            for (let i = 0; i < lefts.length; i++) {
              const d = Math.abs(lefts[i] - x);
              if (d < bestDist) {
                bestDist = d;
                best = i;
              }
            }
            return best;
          };

          const scrollToIndex = (idx) => {
            const lefts = itemLefts();
            const clamped =
              ((idx % items.length) + items.length) % items.length; // safe mod
            track.scrollTo({ left: lefts[clamped], behavior: "smooth" });
          };

          const scrollBy = (dir) => {
            const step = perView();
            const i = currentIndex();
            console.log("current index:", i);

            const target = i + dir * step;
            console.log("scrolling to index:", target);
            scrollToIndex(target);
          };

          // ----- Page dots (pages, not items) -----
          const pageCount = () =>
            Math.max(1, Math.ceil(items.length / perView()));

          const pageIndexFromItem = (itemIdx) =>
            Math.floor(itemIdx / perView());

          const renderDots = () => {
            dotsContainer.innerHTML = "";
            const pc = pageCount();

            for (let p = 0; p < pc; p++) {
              const dot = document.createElement("button");
              dot.type = "button";
              dot.className =
                "h-2.5 w-2.5 rounded-full bg-brand-700/25 hover:bg-brand-700/40 transition";
              dot.setAttribute("aria-label", `Ir para página ${p + 1}`);
              dot.addEventListener("click", (e) => {
                e.preventDefault();
                scrollToIndex(p * perView());
              });
              dotsContainer.appendChild(dot);
            }
          };

          const updateActiveDot = () => {
            const idx = currentIndex();
            const currentPage = pageIndexFromItem(idx);
            const dots = Array.from(dotsContainer.querySelectorAll("button"));

            dots.forEach((dot, i) => {
              const active = i === currentPage;
              dot.classList.toggle("bg-brand-700/70", active);
              dot.classList.toggle("bg-brand-700/25", !active);
              dot.classList.toggle("scale-125", active);
              dot.setAttribute("aria-current", active ? "true" : "false");
            });
          };

          // Events (use pointerdown to avoid scroll-container click weirdness)
          prev.addEventListener(
            "pointerdown",
            (e) => {
              console.log("prev clicked");
              e.preventDefault();
              scrollBy(-1);
            },
            { passive: false }
          );

          next.addEventListener(
            "pointerdown",
            (e) => {
              e.preventDefault();
              scrollBy(1);
            },
            { passive: false }
          );

          // Sync active dot on scroll
          let raf = 0;
          const onScroll = () => {
            cancelAnimationFrame(raf);
            raf = requestAnimationFrame(updateActiveDot);
          };

          track.addEventListener("scroll", onScroll, { passive: true });

          window.addEventListener("resize", () => {
            renderDots();
            // keep current page aligned to nearest item after resize
            scrollToIndex(currentIndex());
            updateActiveDot();
          });

          // Keyboard support
          track.addEventListener("keydown", (e) => {
            if (e.key === "ArrowLeft") scrollBy(-1);
            if (e.key === "ArrowRight") scrollBy(1);
          });

          // Init
          renderDots();
          updateActiveDot();
        };

        init();
        document.addEventListener("astro:page-load", init);
      })();
    </script>
  </div>
</section>
